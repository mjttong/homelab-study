# Session 2

## 개요

- 홈서버 스터디 시즌 2 진행
- 주제: 마인크래프트 서버 구축
- 목표: 홈서버 스터디원들이 외부에서 클라이언트로 참여할 수 있는 마인크래프트 서버 구축

## 진행

- 서버 구성
  - Proxmox OS가 설치된 3대의 물리 서버를 묶어 tailscale 내부망(tailnet) 및 클러스터 구성
  - 마스터 노드에 진입점(리버스 프록시) 설정
- 마인크래프트
  - 마인크래프트는 클라이언트-서버 구조를 취하며 사용자는 클라이언트 런처를 구매해 서버에 접근하는 형태
  - 마인크래프트는 자바, 배드락 에디션으로 구성, 모바일 클라이언트 런처는 모두 배드락 에디션

## 포트 포워딩

### 서비스 노출

- 일반적인 가정용 공유기에 연결된 서버의 서비스를 어떻게 외부에 노출할지 고민
  - 해당 내부망은 외부로부터 단절되어 있고, 공유기를 통해 외부로 트래픽 송수신
  - 공유기는 ISP와 연결되어 공인 IP를 갖고, NAT 역할을 수행해 내부망 내의 기기가 인터넷 연결이 되도록 함
  - 해당 서비스에 접근하기 위해서는 내부망 내 특정 서버의 특정 포트에 접근해야 함
- 서비스 노출을 위해 공유기의 포트 포워딩 기능을 사용 가능
  - 클라이언트는 공유기의 공인 IP와 포트포워딩에 설정된 특정 포트로 접근
  - 공유기는 클라이언트의 특정 포트 요청을 받는 경우, 해당 서버의 해당 포트로 클라이언트 요청 전송

### 포트 포워딩과 보안

- 공유기 포트포워딩은 보안상 부적절할 수 있음
- 포트 포워딩 사용 시 가정용 네트워크의 보안 취약성 발생
- 실제 서비스가 인터넷에 직접적으로 노출될 수 있음

## 리버스 프록시

- 리버스 프록시는 클라이언트가 접근할 명확한 진입 지점을 제공함
  - 포트 포워딩으로 인한 포트 개방보다 안전함
  - 실제 서비스 포트가 아닌 웹 포트(80, 443)만 개방하여 공격 지점 최소화
  - 추가 보안 계층을 리버스 프록시 단에서 수행 가능
- nginx(npm), caddy 등의 서비스를 통해 리버스 프록시 구축 가능
- 리버스 프록시의 도메인 기반 라우팅 사용
  - 클라이언트가 특정 도메인, 웹 포트(80, 443)으로 요청 전송
  - 해당 요청은 공유기에게 도착, 공유기는 웹 포트를 확인한 후 리버스 프록시로 해당 요청을 포트 포워딩
  - 리버스 프록시에게 요청을 받아 도메인에 따라 적절한 서버에 요청 전송

### velocity

- 마인크래프트 자바 에디션 서버 전용 프록시
  - 일반적인 웹 트래픽은 nginx 등의 리버스 프록시로 처리
  - 마인크래프트는 전용 프록시를 별도로 사용해 연결, 관리가 더 쉽도록 함
- 해당 프록시를 리버스 프록시로 사용해 서버 진입 지점으로 배치하고자 함

## 구성

- 마인크래프트 자바 에디션 서버 컨테이너, velocity 컨테이너 이미지를 docker compose를 사용해 구성 및 배포
  - velocity의 velocity.toml 파일 설정
  - 각 클러스터 노드에 마인크래프트 서버 컨테이너 배포
  - 마스터 노드에 velocity 컨테이너 배포 및 노드 간 연결

## 회고

- 점진적 확장의 중요성
  - 단일 VM > 여러 대의 VM > 여러 대의 물리 서버로 확장했어야 함
  - 즉, 아래의 순서를 따라 진행했어야 함
    - 단일 VM에서 단일 컨테이너(velocity, 마인크래프트 서버)로 안정적인 배포
    - 컨테이너 확장
    - VM 추가 및 컨테이너 오케스트레이션 도입
    - 물리 서버 확장 및 Proxmox 클러스터링
  - 그러나 가장 먼저 불필요한 Proxmox 클러스터링부터 진행, 구상과 설계가 매우 어려워짐
- 오버 엔지니어링
  - 소규모 서버에 비해 과도한 인프라 구성을 생각
  - 단일 VM에서 velocity, 마크 서버 컨테이너 2개만 있었어도 충분히 목표를 달성했을 것이라고 생각
